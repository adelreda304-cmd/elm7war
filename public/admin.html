<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elm7war Admin Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0b1d39',
                            card: '#132f5b',
                            accent: '#3b82f6',
                            success: '#10b981',
                            danger: '#ef4444'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
    </style>
</head>
<body class="bg-brand-dark text-white min-h-screen flex hidden" id="app">

    <!-- Sidebar -->
    <aside class="w-64 bg-brand-card flex flex-col shadow-xl fixed h-full z-10 transition-transform transform -translate-x-full md:translate-x-0 md:static" id="sidebar">
        <div class="p-6 border-b border-gray-700 flex items-center justify-between">
            <h1 class="text-2xl font-bold text-brand-accent">Elm7war <span class="text-white text-sm block font-normal">Admin Panel</span></h1>
            <button class="md:hidden text-gray-400 hover:text-white" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="nav('dashboard')" class="nav-item w-full flex items-center p-3 rounded hover:bg-white/10 transition text-brand-accent font-bold bg-white/5">
                <i class="fas fa-home w-8"></i> Dashboard
            </button>
            <button onclick="nav('rooms')" class="nav-item w-full flex items-center p-3 rounded hover:bg-white/10 transition">
                <i class="fas fa-gamepad w-8"></i> Rooms
            </button>
            <button onclick="nav('users')" class="nav-item w-full flex items-center p-3 rounded hover:bg-white/10 transition">
                <i class="fas fa-users w-8"></i> Registrations
            </button>
            <button onclick="nav('results')" class="nav-item w-full flex items-center p-3 rounded hover:bg-white/10 transition">
                <i class="fas fa-trophy w-8"></i> Results
            </button>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <button onclick="logout()" class="w-full flex items-center p-3 rounded hover:bg-brand-danger/20 text-brand-danger transition">
                <i class="fas fa-sign-out-alt w-8"></i> Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-8 overflow-y-auto w-full">
        <!-- Header Mobile -->
        <div class="md:hidden flex items-center justify-between mb-6">
            <h1 class="text-xl font-bold">Admin Panel</h1>
            <button onclick="toggleSidebar()" class="text-2xl"><i class="fas fa-bars"></i></button>
        </div>

        <!-- Views -->
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section animate-fade-in">
            <h2 class="text-3xl font-bold mb-6">Overview</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-brand-card p-6 rounded-xl shadow-lg border-b-4 border-brand-accent">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm">Active Rooms</p>
                            <h3 class="text-4xl font-bold mt-2" id="stat-rooms">0</h3>
                        </div>
                        <div class="p-3 bg-brand-accent/20 rounded-lg text-brand-accent">
                            <i class="fas fa-gamepad text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-brand-card p-6 rounded-xl shadow-lg border-b-4 border-brand-success">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm">Registrations</p>
                            <h3 class="text-4xl font-bold mt-2" id="stat-registrations">0</h3>
                        </div>
                        <div class="p-3 bg-brand-success/20 rounded-lg text-brand-success">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-brand-card p-6 rounded-xl shadow-lg border-b-4 border-yellow-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm">Pending Approval</p>
                            <h3 class="text-4xl font-bold mt-2" id="stat-pending">0</h3>
                        </div>
                        <div class="p-3 bg-yellow-500/20 rounded-lg text-yellow-500">
                            <i class="fas fa-clock text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-brand-card rounded-xl p-6">
                <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
                <div class="flex gap-4">
                    <button onclick="nav('rooms'); document.getElementById('btn-create-room').click()" class="bg-brand-accent hover:bg-blue-600 px-6 py-3 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> Create New Room
                    </button>
                    <button onclick="nav('users')" class="bg-brand-card border border-white/20 hover:bg-white/5 px-6 py-3 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                        <i class="fas fa-list"></i> Review Registrations
                    </button>
                </div>
            </div>
        </div>

        <!-- ROOMS VIEW -->
        <div id="view-rooms" class="view-section hidden animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Manage Rooms</h2>
                <button id="btn-create-room" onclick="openModal('modal-room')" class="bg-brand-success hover:bg-green-600 px-4 py-2 rounded-lg font-bold shadow transition">
                    <i class="fas fa-plus mr-2"></i> Create Room
                </button>
            </div>
            
            <div class="bg-brand-card rounded-xl overflow-hidden shadow-xl">
                <div class="overflow-x-auto">
                    <table class="w-full text-right" dir="rtl">
                        <thead class="bg-black/20 text-gray-300">
                            <tr>
                                <th class="p-4">Room Name</th>
                                <th class="p-4">Mode</th>
                                <th class="p-4">Start Time</th>
                                <th class="p-4">Type</th>
                                <th class="p-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-rooms" class="divide-y divide-gray-700 text-gray-200">
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
                <div id="loader-rooms" class="p-8 text-center text-gray-400 hidden">Loading...</div>
                <div id="empty-rooms" class="p-8 text-center text-gray-400 hidden">No rooms found.</div>
            </div>
        </div>

        <!-- USERS VIEW -->
        <div id="view-users" class="view-section hidden animate-fade-in">
            <h2 class="text-3xl font-bold mb-6">Player Registrations</h2>
            <div class="mb-4 flex gap-2">
                <button onclick="filterRegistrations('all')" class="px-4 py-2 rounded bg-brand-accent text-white">All</button>
                <button onclick="filterRegistrations('pending')" class="px-4 py-2 rounded bg-yellow-600 text-white">Pending</button>
                <button onclick="filterRegistrations('approved')" class="px-4 py-2 rounded bg-brand-success text-white">Approved</button>
            </div>

            <div class="bg-brand-card rounded-xl overflow-hidden shadow-xl">
                <div class="overflow-x-auto">
                    <table class="w-full text-right" dir="rtl">
                        <thead class="bg-black/20 text-gray-300">
                            <tr>
                                <th class="p-4">Player Name</th>
                                <th class="p-4">FreeFire ID</th>
                                <th class="p-4">Status</th>
                                <th class="p-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-registrations" class="divide-y divide-gray-700 text-gray-200">
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RESULTS VIEW -->
        <div id="view-results" class="view-section hidden animate-fade-in">
             <h2 class="text-3xl font-bold mb-6">Publish Results</h2>
             <div class="bg-brand-card p-6 rounded-xl max-w-2xl">
                 <form onsubmit="submitResult(event)" class="space-y-4">
                     <div>
                         <label class="block text-gray-400 mb-2">Select Room</label>
                         <select id="result-room-select" class="w-full bg-brand-dark border-2 border-transparent focus:border-brand-accent rounded p-3 text-white outline-none transition">
                             <option value="">Choose a room...</option>
                         </select>
                     </div>
                     <div>
                         <label class="block text-gray-400 mb-2">Winners (Comma separated, e.g. "Ahmed, Mohamed")</label>
                         <textarea id="result-winners" rows="3" class="w-full bg-brand-dark border-2 border-transparent focus:border-brand-accent rounded p-3 text-white outline-none transition" placeholder="Enter winner names or IDs"></textarea>
                     </div>
                     <button type="submit" class="w-full bg-brand-accent hover:bg-blue-600 py-3 rounded-lg font-bold shadow-lg transition">
                         Publish Result
                     </button>
                 </form>
             </div>
             
             <h3 class="text-2xl font-bold mt-8 mb-4">Past Results</h3>
             <div id="list-results" class="space-y-4">
                 <!-- Results List -->
             </div>
        </div>

    </main>

    <!-- Modal Create Room -->
    <div id="modal-room" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-brand-card w-full max-w-md p-6 rounded-xl shadow-2xl transform transition-all scale-95 border border-gray-700">
            <h3 class="text-2xl font-bold mb-4">Create New Room</h3>
            <form id="form-create-room" onsubmit="handleCreateRoom(event)" class="space-y-4">
                <input type="text" id="inp-room-name" placeholder="Room Name" class="w-full bg-brand-dark p-3 rounded border border-gray-600 focus:border-brand-accent outline-none" required>
                <div class="flex gap-2">
                    <input type="text" id="inp-room-mode" placeholder="Mode (e.g. Squad)" class="w-1/2 bg-brand-dark p-3 rounded border border-gray-600 focus:border-brand-accent outline-none" required>
                    <select id="inp-room-paid" class="w-1/2 bg-brand-dark p-3 rounded border border-gray-600 focus:border-brand-accent outline-none">
                        <option value="false">Free</option>
                        <option value="true">Paid</option>
                    </select>
                </div>
                <input type="datetime-local" id="inp-room-time" class="w-full bg-brand-dark p-3 rounded border border-gray-600 focus:border-brand-accent outline-none text-gray-400" required>
                <input type="text" id="inp-room-prize" placeholder="Prize Pool" class="w-full bg-brand-dark p-3 rounded border border-gray-600 focus:border-brand-accent outline-none">
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('modal-room')" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-brand-accent hover:bg-blue-600 rounded font-bold">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-brand-dark z-[60] flex items-center justify-center p-4">
        <div class="bg-brand-card w-full max-w-sm p-8 rounded-2xl shadow-2xl border border-gray-700 text-center">
            <div class="mb-6 inline-block p-4 bg-brand-accent/20 rounded-full text-brand-accent">
                <i class="fas fa-lock text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-6">Admin Access</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="email" id="login-email" placeholder="admin@elm7war.com" class="w-full bg-brand-dark p-3 rounded border border-gray-600 focus:border-brand-accent outline-none text-center" required>
                <input type="password" id="login-pass" placeholder="Password" class="w-full bg-brand-dark p-3 rounded border border-gray-600 focus:border-brand-accent outline-none text-center" required>
                <button type="submit" class="w-full bg-brand-accent hover:bg-blue-600 py-3 rounded-lg font-bold transition">LOGIN</button>
            </form>
            <p id="login-error" class="text-brand-danger mt-4 text-sm hidden">Invalid credentials</p>
        </div>
    </div>

    <script>
        // --- STATE & UTILS ---
        let token = localStorage.getItem('admin_token');
        const api = async (url, method='GET', body=null) => {
            const opts = { method, headers: { 'Content-Type': 'application/json' }};
            if(token) opts.headers['Authorization'] = 'Bearer ' + token;
            if(body) opts.body = JSON.stringify(body);
            const res = await fetch(url, opts);
            if(res.status === 401) logout();
            return res;
        };
        const el = id => document.getElementById(id);
        const formatTime = d => new Date(d).toLocaleString('ar-EG');

        // --- INIT ---
        window.addEventListener('load', () => {
             document.body.classList.remove('hidden');
            if(!token) {
                el('login-overlay').classList.remove('hidden');
            } else {
                el('login-overlay').classList.add('hidden');
                initApp();
            }
        });

        async function initApp(){
            await Promise.all([loadRooms(), loadRegistrations()]);
            updateStats();
        }

        // --- AUTH ---
        async function handleLogin(e){
            e.preventDefault();
            const email = el('login-email').value;
            const password = el('login-pass').value;
            const res = await api('/api/admin/login', 'POST', { email, password });
            if(res.ok){
                const data = await res.json();
                token = data.token;
                localStorage.setItem('admin_token', token);
                el('login-overlay').classList.add('hidden');
                initApp();
            } else {
                el('login-error').classList.remove('hidden');
            }
        }
        function logout(){
            localStorage.removeItem('admin_token');
            location.reload();
        }

        // --- NAVIGATION ---
        function nav(viewName){
            document.querySelectorAll('.view-section').forEach(d => d.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(b => {
                b.classList.remove('bg-white/5', 'text-brand-accent', 'font-bold');
                b.classList.add('text-gray-400');
            });
            
            el('view-'+viewName).classList.remove('hidden');
            
            // Highlight active nav
            const btn = document.querySelector(`button[onclick="nav('${viewName}')"]`);
            if(btn){
                btn.classList.add('bg-white/5', 'text-brand-accent', 'font-bold');
                btn.classList.remove('text-gray-400');
            }

            // Mobile: close sidebar
            if(window.innerWidth < 768) el('sidebar').classList.add('-translate-x-full');
        }
        function toggleSidebar(){
            el('sidebar').classList.toggle('-translate-x-full');
        }

        // --- ROOMS ---
        let roomsData = [];
        async function loadRooms(){
            const res = await api('/api/admin/rooms');
            if(res.ok){
                roomsData = await res.json();
                renderRooms();
                updateRoomSelect();
            }
        }
        function renderRooms(){
            const tbody = el('table-rooms');
            if(roomsData.length === 0) {
                tbody.innerHTML = '';
                el('empty-rooms').classList.remove('hidden');
                return;
            }
            el('empty-rooms').classList.add('hidden');
            
            tbody.innerHTML = roomsData.map(r => `
                <tr class="hover:bg-brand-card/50 transition">
                    <td class="p-4 font-bold text-white">${r.name}</td>
                    <td class="p-4 text-sm">${r.mode}</td>
                    <td class="p-4 text-sm text-gray-400" dir="ltr">${new Date(r.startTime).toLocaleString()}</td>
                    <td class="p-4"><span class="${r.isPaid ? 'text-yellow-400 border border-yellow-400/30 bg-yellow-400/10' : 'text-green-400 border border-green-400/30 bg-green-400/10'} px-2 py-1 rounded text-xs font-bold">${r.isPaid ? 'PAID' : 'FREE'}</span></td>
                    <td class="p-4 text-center">
                        <button onclick="deleteRoom('${r._id}')" class="text-brand-danger hover:bg-brand-danger/20 p-2 rounded transition" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            
            el('stat-rooms').innerText = roomsData.length;
        }
        async function handleCreateRoom(e){
            e.preventDefault();
            const body = {
                name: el('inp-room-name').value,
                mode: el('inp-room-mode').value,
                startTime: el('inp-room-time').value,
                prize: el('inp-room-prize').value,
                isPaid: el('inp-room-paid').value === 'true'
            };
            const res = await api('/api/admin/rooms', 'POST', body);
            if(res.ok){
                closeModal('modal-room');
                e.target.reset();
                loadRooms();
            } else {
                alert('Error creating room');
            }
        }
        async function deleteRoom(id){
            if(!confirm('Are you sure you want to delete this room?')) return;
            await api('/api/admin/rooms/'+id, 'DELETE');
            loadRooms();
        }

        // --- REGISTRATIONS ---
        let regsData = [];
        let currentFilter = 'all';
        async function loadRegistrations(){
            const res = await api('/api/admin/registrations');
            if(res.ok){
                regsData = await res.json();
                renderRegistrations();
            }
        }
        function filterRegistrations(type){
            currentFilter = type;
            renderRegistrations();
        }
        function renderRegistrations(){
            let filtered = regsData;
            if(currentFilter !== 'all') filtered = regsData.filter(r => r.status === currentFilter);
            
            el('table-registrations').innerHTML = filtered.map(r => `
                <tr class="hover:bg-brand-card/50 transition">
                    <td class="p-4 font-bold text-white">${r.playerName}</td>
                    <td class="p-4 font-mono text-brand-accent">${r.freeFireId}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${
                            r.status==='approved'?'bg-green-500/10 text-green-500 border border-green-500/20' : 
                            r.status==='rejected'?'bg-red-500/10 text-red-500 border border-red-500/20' : 
                            'bg-yellow-500/10 text-yellow-500 border border-yellow-500/20'
                        }">
                            ${r.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        ${r.status === 'pending' ? `
                            <button onclick="approveReg('${r._id}')" class="text-brand-success hover:bg-brand-success/20 p-2 rounded transition" title="Approve"><i class="fas fa-check"></i></button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');

            el('stat-registrations').innerText = regsData.length;
            el('stat-pending').innerText = regsData.filter(r => r.status === 'pending').length;
        }
        async function approveReg(id){
            await api(`/api/admin/registrations/${id}/approve`, 'POST');
            loadRegistrations();
        }

        // --- RESULTS ---
        function updateRoomSelect(){
            const sel = el('result-room-select');
            sel.innerHTML = '<option value="">Choose a room...</option>' + 
                            roomsData.map(r => `<option value="${r._id}">${r.name}</option>`).join('');
        }
        async function submitResult(e){
            e.preventDefault();
            const roomId = el('result-room-select').value;
            const winners = el('result-winners').value.split(',').map(s => s.trim());
            
            if(!roomId) return alert('Please select a room');
            
            const res = await api('/api/admin/results', 'POST', { roomId, winners });
            if(res.ok){
                alert('Results published!');
                e.target.reset();
            }
        }

        // --- UTILS UI ---
        function openModal(id){ el(id).classList.remove('hidden'); }
        function closeModal(id){ el(id).classList.add('hidden'); }
        function updateStats(){
            // Stats updated inside render functions mostly
        }

    </script>
</body>
</html>
